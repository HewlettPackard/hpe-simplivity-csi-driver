<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Offline Volume Expansion - HPE SimpliVity VMware CSI Driver</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../css/hpedev.css" rel="stylesheet" />
        <link href="../css/customizations.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Offline Volume Expansion";
        var mkdocs_page_input_path = "volume-expansion.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> HPE SimpliVity VMware CSI Driver
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Welcome</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="..">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../quickstart/">Quickstart Guide</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Prerequisites</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/prerequisites-deployment/prerequisites/">Prerequisites</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/prerequisites-deployment/setup-base-template/">Setup Base Template</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/prerequisites-deployment/setup-master-and-worker-nodes/">Setup Master and Worker Nodes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/prerequisites-deployment/install-cpi/">Install CPI</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/prerequisites-deployment/install-csi-snapshot-controller/">Install CSI Snapshot Controller</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Driver Deployment</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/configuring-topologies/">Configuring Topologies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/uninstallation/">Uninstallation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Using CSI Driver</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../setup/">Setup HPE SimpliVity for CSI</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../using-topologies/">Using Topologies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../block-volumes/">Block Volumes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../snapshot/">Volume Snapshots</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Offline Volume Expansion</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#requirements">Requirements</a>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Support</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../support-information/">Support Information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../known-issues/">Known Issues</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">HPE SimpliVity VMware CSI Driver</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Using CSI Driver &raquo;</li>
      <li>Offline Volume Expansion</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <!-- markdownlint-disable MD033 -->
<!-- markdownlint-disable MD014 -->
<h1 id="hpe-simplivity-csi-driver-offline-volume-expansion">HPE SimpliVity CSI Driver - Offline Volume Expansion</h1>
<p>CSI Volume Expansion was introduced as an alpha feature in Kubernetes 1.14 and it was promoted to beta in Kubernetes 1.16. CSI Offline Volume Expansion is available from v2.0.0 of the HPE SimpliVity Driver. Currently, online expansion(ie, When the PVC is being used by a Pod i.e it is mounted on a node, the resulting volume expansion) is not supported.</p>
<p>The offline volume expansion feature of CSI is basically the ability to extend / grow a Kubernetes Persistent Volume (PV) when it is not attached to a node. Currently, Offline Volume Expansion is supported only on dynamically created volumes.</p>
<h2 id="requirements">Requirements</h2>
<p>Make sure all the ESXi hosts of the cluster are on the same version as the vCenter. For volume expansion to work, the vCenter and all the ESX hosts of the cluster need to be on the supported versions of the feature i.e version 7.0 and above, otherwise volume resize operation fails with A general system error occurred: Failed to lock the file: api = DiskLib_Grow error.</p>
<h3 id="offline-volume-expansion">Offline Volume Expansion</h3>
<p>Create a new StorageClass or edit the existing StorageClass to set allowVolumeExpansion to true.</p>
<pre class="highlight"><code class="language-yaml"># Contents of example-sc.yaml
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: simplivity-sc
  annotations:
    storageclass.kubernetes.io/is-default-class: "false"
provisioner: csi.simplivity.hpe.com
allowVolumeExpansion: true
reclaimPolicy: Delete
parameters:
  # datastoreurl and storagepolicyname are mutually exclusive.
  # datastoreurl: "ds:///vmfs/volumes/9c8391e9-05250c25/"  # Storage URL, found under storage tab in vCenter
  # storagepolicyname: "policy-name"  # Policy on selected datastore, from vCenter
  # Optional Parameter
  fstype: "ext4"</code></pre>
<p>Create this StorageClass into the Kubernetes Cluster:</p>
<pre class="highlight"><code class="language-text">$ kubectl create -f example-sc.yaml</code></pre>
<p>Define a PersistentVolumeClaim using the above StorageClass and create a PersistentVolumeClaim in the Kubernetes Cluster:</p>
<pre class="highlight"><code class="language-yaml"># Contents of example-pvc.yaml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: example-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: simplivity-sc</code></pre>
<pre class="highlight"><code class="language-text">$ kubectl create -f example-pvc.yaml</code></pre>
<p>Now patch the created PVC to increase its requested storage size (in this case, to 4Gi):</p>
<pre class="highlight"><code class="language-text"># Alternatively, the size can be changed by modifying the spec using kubectl edit pvc example-pvc
$ kubectl patch pvc example-pvc -p '{"spec": {"resources": {"requests": {"storage": "4Gi"}}}}'
persistentvolumeclaim/example-pvc patched</code></pre>
<p>This will trigger an expansion in the volume associated with the PVC in vSphere Cloud Native Storage and also gets reflected on the capacity of the corresponding PV</p>
<pre class="highlight"><code class="language-text">$ kubectl describe pvc example-pvc
Name:          example-pvc
Namespace:     default
StorageClass:  simplivity-sc
Status:        Bound
Volume:        pvc-f6fb41c4-fda5-4768-9a68-3cb8b27967da
Labels:        &lt;none&gt;
Annotations:   pv.kubernetes.io/bind-completed: yes
               pv.kubernetes.io/bound-by-controller: yes
               volume.beta.kubernetes.io/storage-provisioner: csi.simplivity.hpe.com
Finalizers:    [kubernetes.io/pvc-protection]
Capacity:      4Gi
Access Modes:  RWO
VolumeMode:    Filesystem
Mounted By:    &lt;none&gt;
Events:
  Type    Reason                 Age                   From                                                                              Message
  ----    ------                 ----                  ----                                                                              -------
  Normal  Provisioning           3m48s                 csi.simplivity.hpe.com_svt-csi-controller-0_e9cdfeaf-603c-45a4-837b-3e5b86beb6d7  External provisioner is provisioning volume for claim "default/example-pvc"
  Normal  ExternalProvisioning   3m8s (x4 over 3m48s)  persistentvolume-controller                                                       waiting for a volume to be created, either by external provisioner "csi.simplivity.hpe.com" or manually created by system administrator
  Normal  ProvisioningSucceeded  2m56s                 csi.simplivity.hpe.com_svt-csi-controller-0_e9cdfeaf-603c-45a4-837b-3e5b86beb6d7  Successfully provisioned volume pvc-f6fb41c4-fda5-4768-9a68-3cb8b27967da</code></pre>
<pre class="highlight"><code class="language-text">$ kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                         STORAGECLASS    REASON   AGE
pvc-f6fb41c4-fda5-4768-9a68-3cb8b27967da   4Gi        RWO            Delete           Bound    default/example-pvc           simplivity-sc            8m27s

$ kubectl describe pv pvc-f6fb41c4-fda5-4768-9a68-3cb8b27967da
Name:            pvc-f6fb41c4-fda5-4768-9a68-3cb8b27967da
Labels:          &lt;none&gt;
Annotations:     pv.kubernetes.io/provisioned-by: csi.simplivity.hpe.com
Finalizers:      [kubernetes.io/pv-protection]
StorageClass:    simplivity-sc
Status:          Bound
Claim:           default/example-pvc
Reclaim Policy:  Delete
Access Modes:    RWO
VolumeMode:      Filesystem
Capacity:        4Gi
Node Affinity:   &lt;none&gt;
Message:
Source:
    Type:              CSI (a Container Storage Interface (CSI) volume source)
    Driver:            csi.simplivity.hpe.com
    VolumeHandle:      d3cff17d-334a-4217-b55d-e478648c5b8d
    ReadOnly:          false
    VolumeAttributes:      datastoreurl=ds:///vmfs/volumes/9c8391e9-05250c25/
                          fstype=ext4
                          storage.kubernetes.io/csiProvisionerIdentity=1589547226925-8081-csi.simplivity.hpe.com
                          type=HPE SimpliVity CNS Block Volume
Events:                &lt;none&gt;</code></pre>
<p>Note that if a PVC, that is being used by a pod, is expanded, then the expansion will fail. However, once the pod is no longer using the PVC, then the expansion that failed  earlier, will be attempted.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../snapshot/" class="btn btn-neutral float-left" title="Volume Snapshots"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../support-information/" class="btn btn-neutral float-right" title="Support Information">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>©️ Copyright 2021 - Hewlett Packard Enterprise Development LP</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../snapshot/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../support-information/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../js/navcleanup.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(false);
        };
    </script>

</body>
</html>
