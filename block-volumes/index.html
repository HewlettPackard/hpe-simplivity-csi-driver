<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Block Volumes - HPE SimpliVity VMware CSI Driver</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../css/hpedev.css" rel="stylesheet" />
  <link href="../css/customizations.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Block Volumes";
    var mkdocs_page_input_path = "block-volumes.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> HPE SimpliVity VMware CSI Driver</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <p class="caption"><span class="caption-text">Welcome</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Overview</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../quickstart/">Quickstart Guide</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Prerequisites</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/prerequisites-deployment/prerequisites/">Prerequisites</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/prerequisites-deployment/setup-base-template/">Setup Base Template</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/prerequisites-deployment/setup-master-and-worker-nodes/">Setup Master and Worker Nodes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/prerequisites-deployment/install-cpi/">Install CPI</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/prerequisites-deployment/install-csi-snapshot-controller/">Install CSI Snapshot Controller</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Driver Deployment</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/installation/">Installation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/configuring-topologies/">Configuring Topologies</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../driver-deployment/uninstallation/">Uninstallation</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Using CSI Driver</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../setup/">Setup HPE SimpliVity for CSI</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../using-topologies/">Using Topologies</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Block Volumes</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#dynamically-provisioning-a-volume">Dynamically Provisioning a Volume </a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#statically-provisioning-a-volume">Statically Provisioning a Volume </a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../snapshot/">Volume Snapshots</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../volume-expansion/">Offline Volume Expansion</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Support</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../support-information/">Support Information</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../known-issues/">Known Issues</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">HPE SimpliVity VMware CSI Driver</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Using CSI Driver &raquo;</li>
        
      
    
    <li>Block Volumes</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <!-- markdownlint-disable MD033 -->
<!-- markdownlint-disable MD014 -->
<h1 id="hpe-simplivity-csi-driver-block-volumes">HPE SimpliVity CSI Driver - Block Volumes</h1>
<p>There are two types of volume provisioning in a Kubernetes cluster:</p>
<ol>
<li><a href="#dynamically_provision_volume">Dynamically Provisioning a Volume</a></li>
<li><a href="#statically_provision_volume">Statically Provisioning a Volume</a></li>
</ol>
<h2 id="dynamically-provisioning-a-volume">Dynamically Provisioning a Volume <a id="dynamically_provision_volume"></a></h2>
<p>Dynamically provisioning a volume allows storage volumes to be created on-demand.</p>
<p>The dynamic provisioning eliminates the need for cluster administrators to pre-provision storage. Instead, it automatically provisions storage when it is requested by a user.</p>
<p>The implementation of dynamic volume provisioning is based on the API object StorageClass from the API group storage.k8s.io. A cluster administrator can define as many StorageClass objects as needed, each specifying a volume plugin (a.k.a provisioner) that provisions a volume and a set of parameters to that provisioner when provisioning. A cluster administrator can define and expose multiple flavors of storage (from the same or different storage systems) within a cluster, each with a custom set of parameters.</p>
<h3 id="how-to-dynamically-provision-a-block-volume-on-a-kubernetes-cluster">How to Dynamically Provision a Block Volume on a Kubernetes Cluster</h3>
<p>Define a StorageClass for the HPE SimpliVity CSI driver as the provisioner. A datastore URL or storage policy can be used to further restrict which datastore will be used by this storage class. In this case, neither are specified which means the driver will select the SimpliVity datastore with the most free space:</p>
<pre class="highlight"><code class="language-yaml"># Contents of example-sc.yaml
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: simplivity-sc
  annotations:
    storageclass.kubernetes.io/is-default-class: "false"
provisioner: csi.simplivity.hpe.com
parameters:
  # datastoreurl and storagepolicyname are mutually exclusive.
# datastoreurl: "ds:///vmfs/volumes/9c8391e9-05250c25/"  # Storage URL, found under storage tab in vCenter
# storagepolicyname: "policy-name"  # Policy on selected datastore, from vCenter
  # Optional Parameter
  fstype: "ext4"</code></pre>
<p>Create this StorageClass into the Kubernetes Cluster:</p>
<pre class="highlight"><code class="language-text">$ kubectl create -f example-sc.yaml</code></pre>
<p>Define a PersistentVolumeClaim:</p>
<pre class="highlight"><code class="language-yaml"># Contents of example-dynamic-pvc.yaml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: example-dynamic-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: simplivity-sc</code></pre>
<p>Create this PersistentVolumeClaim in the Kubernetes Cluster:</p>
<pre class="highlight"><code class="language-text">$ kubectl create -f example-dynamic-pvc.yaml</code></pre>
<p>A PersistentVolume is dynamically created and is bound to this PersistentVolumeClaim. Verify that the PersistentVolumeClaim was created and a PersistentVolume is attached to it.</p>
<p>The base status should show Bound if it worked and the Volume field should be populated.</p>
<pre class="highlight"><code class="language-text">$ kubectl get pvc
NAME                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS    AGE
example-dynamic-pvc   Bound    pvc-f6fb41c4-fda5-4768-9a68-3cb8b27967da   5Gi        RWO            simplivity-sc   2m19s</code></pre>
<p>Details of the PVC</p>
<pre class="highlight"><code class="language-text">$ kubectl describe pvc example-dynamic-pvc
Name:          example-dynamic-pvc
Namespace:     default
StorageClass:  simplivity-sc
Status:        Bound
Volume:        pvc-f6fb41c4-fda5-4768-9a68-3cb8b27967da
Labels:        &lt;none&gt;
Annotations:   pv.kubernetes.io/bind-completed: yes
              pv.kubernetes.io/bound-by-controller: yes
              volume.beta.kubernetes.io/storage-provisioner: csi.simplivity.hpe.com
Finalizers:    [kubernetes.io/pvc-protection]
Capacity:      5Gi
Access Modes:  RWO
VolumeMode:    Filesystem
Mounted By:    &lt;none&gt;
Events:
  Type    Reason                 Age                   From                                                                              Message
  ----    ------                 ----                  ----                                                                              -------
  Normal  Provisioning           3m48s                 csi.simplivity.hpe.com_svt-csi-controller-0_e9cdfeaf-603c-45a4-837b-3e5b86beb6d7  External provisioner is provisioning volume for claim "default/example-dynamic-pvc"
  Normal  ExternalProvisioning   3m8s (x4 over 3m48s)  persistentvolume-controller                                                       waiting for a volume to be created, either by external provisioner "csi.simplivity.hpe.com" or manually created by system administrator
  Normal  ProvisioningSucceeded  2m56s                 csi.simplivity.hpe.com_svt-csi-controller-0_e9cdfeaf-603c-45a4-837b-3e5b86beb6d7  Successfully provisioned volume pvc-f6fb41c4-fda5-4768-9a68-3cb8b27967da</code></pre>
<p>Here, ReadWriteOnce (RWO) access mode indicates that the volume provisioned is a Block Volume. In both the basic <code>get</code> information and the detailed <code>describe</code> information of the PVC, the volume is shown in the <code>Volume</code> field.</p>
<pre class="highlight"><code class="language-text">$ kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                         STORAGECLASS    REASON   AGE
pvc-f6fb41c4-fda5-4768-9a68-3cb8b27967da   5Gi        RWO            Delete           Bound    default/example-dynamic-pvc   simplivity-sc            8m27s

$ kubectl describe pv pvc-f6fb41c4-fda5-4768-9a68-3cb8b27967da
Name:            pvc-f6fb41c4-fda5-4768-9a68-3cb8b27967da
Labels:          &lt;none&gt;
Annotations:     pv.kubernetes.io/provisioned-by: csi.simplivity.hpe.com
Finalizers:      [kubernetes.io/pv-protection]
StorageClass:    simplivity-sc
Status:          Bound
Claim:           default/example-dynamic-pvc
Reclaim Policy:  Delete
Access Modes:    RWO
VolumeMode:      Filesystem
Capacity:        5Gi
Node Affinity:   &lt;none&gt;
Message:
Source:
    Type:              CSI (a Container Storage Interface (CSI) volume source)
    Driver:            csi.simplivity.hpe.com
    VolumeHandle:      d3cff17d-334a-4217-b55d-e478648c5b8d
    ReadOnly:          false
    VolumeAttributes:      datastoreurl=ds:///vmfs/volumes/188e6f22-173b61ae/
                          fstype=ext4
                          storage.kubernetes.io/csiProvisionerIdentity=1589547226925-8081-csi.simplivity.hpe.com
                          type=HPE SimpliVity CNS Block Volume
Events:                &lt;none&gt;</code></pre>
<p>The <code>Status:</code> in both the outputs say <code>bound</code> and the <code>Claim:</code> points to the PVC that was created earlier <code>default/example-dynamic-pvc</code>.</p>
<p>This created a new volume and attached it to the application for the user.</p>
<h2 id="statically-provisioning-a-volume">Statically Provisioning a Volume <a id="statically_provision_volume"></a></h2>
<p>Use this method when there is already an existing volume that is wanted by the Kubernetes cluster. Static provisioning is a feature that is native to Kubernetes and that allows cluster administrators to make existing storage devices available to a cluster.</p>
<p>As a cluster administrator, you must know the details of the storage device, its supported configurations, and mount options.</p>
<p>To make existing storage available to a cluster user, you must manually create the storage device, a PeristentVolume, and a PersistentVolumeClaim. Because the PV and the storage device already exists, there is no need to specify a storage class name in the PVC spec. There are many ways to create a static PV and PVC binding, some examples are label matching, volume size matching etc...</p>
<h3 id="use-cases-of-static-provisioning">Use Cases of Static Provisioning</h3>
<p>Common use cases supported for static volume provisioning:</p>
<ul>
<li>
<p><strong>Use an existing storage device:</strong> You provisioned a persistent storage First Class Disk (FCD) directly in your VC and want to use this FCD in your cluster.</p>
</li>
<li>
<p><strong>Make retained data available to the cluster:</strong> You provisioned a volume with a <code>reclaimPolicy: retain</code> in the storage class by using dynamic provisioning. You removed the PVC, but the PV, the physical storage in the VC, and the data still exist. You want to access the retained data from the same or another app in your cluster.</p>
</li>
</ul>
<h3 id="how-to-statically-provision-a-block-volume-on-a-kubernetes-cluster">How to Statically Provision a Block Volume on a Kubernetes Cluster</h3>
<p>First a FCD ID will need to be obtained for the volume. If the volume is not already a FCD it will need to be registered as one. This command will regiseter the volume as a FCD and return the FCD ID</p>
<pre class="highlight"><code class="language-text">$ govc disk.register -ds=&lt;datastore name&gt; &lt;myVMDKdirectory/mydisk.vmdk&gt; &lt;new FCD name&gt;</code></pre>
<p>If the volume is already a FCD, the FCD ID can be retrieved with the <code>PowerCLI</code> or <code>govc</code> utility</p>
<ul>
<li>PowerCLI</li>
</ul>
<pre class="highlight"><code class="language-text">$ Connect-VIServer &lt;vCenter ip&gt; -User administrator@vsphere.local -Password &lt;vCenter password&gt;
$ (Get-VDisk -Name &lt;new FCD name&gt;).id.Split(':')[1]
3515afd9-150e-4603-9267-7f0ff165ae63</code></pre>
<ul>
<li>GOVC</li>
</ul>
<pre class="highlight"><code class="language-text">$ govc disk.ls
3515afd9-150e-4603-9267-7f0ff165ae63  static-pv</code></pre>
<p>Define a PersistentVolume (PV) that links a FCD to Kubernetes</p>
<pre class="highlight"><code class="language-yaml">apiVersion: v1
kind: PersistentVolume
metadata:
  name: static-pv-name  # Set name of new PV
  labels:
    "fcd-id": "3515afd9-150e-4603-9267-7f0ff165ae63"
    # This label is used as selector to bind with volume claim.
    # This can we any unique key-value to identify PV.
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  csi:
    driver: csi.simplivity.hpe.com  # make sure this says `csi.simplivity.hpe.com`
    fsType: ext4
    volumeAttributes:
      fstype: ""
      storage.kubernetes.io/csiProvisionerIdentity: static-pv-name-csi.simplivity.hpe.com  # update this
      type: "vSphere CNS Block Volume"
      datastoreurl: "ds:///vmfs/volumes/9c8391e9-05250c25/"  # Storage URL, found under storage tab in vCenter
    volumeHandle: 3515afd9-150e-4603-9267-7f0ff165ae63  # First Class Disk (Improved Virtual Disk) ID</code></pre>
<p>Define a PersistentVolumeClaim (PVC), which makes the PV useable by another Kubernetes resource like a Pod or StatefulSet.</p>
<pre class="highlight"><code class="language-yaml">kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: static-pvc-name
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  selector:
    matchLabels:
      fcd-id: 3515afd9-150e-4603-9267-7f0ff165ae63 # This label is used as selector to find matching PV with specified key and value.
  storageClassName: ""</code></pre>
<p>Create a static PV</p>
<pre class="highlight"><code class="language-text">$ kubectl apply -f static-pv.yaml
persistentvolume/static-pv-name created

$ kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                         STORAGECLASS    REASON   AGE
static-pv-name                             1Gi        RWO            Retain           Available                                                          5s</code></pre>
<p>Create PVC for the static PV. The PVC will be bound to the PV in the Volume column. While the PV will be updated with a <code>Claim</code> and the <code>Status</code> will be updated to <code>Bound</code>.</p>
<pre class="highlight"><code class="language-text">$ kubectl apply -f static-pvc.yaml
persistentvolumeclaim/static-pvc-name created

$ kubectl get pvc
NAME                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS    AGE
static-pvc-name       Bound    static-pv-name                             1Gi        RWO                            8s

$ kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                         STORAGECLASS    REASON   AGE
static-pv-name                             1Gi        RWO            Retain           Bound    default/static-pvc-name                                2m</code></pre>
<p>The PV is now ready to be used by Kubernetes through the PVC it is bound to.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../snapshot/" class="btn btn-neutral float-right" title="Volume Snapshots">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../using-topologies/" class="btn btn-neutral" title="Using Topologies"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>©️ Copyright 2021 - Hewlett Packard Enterprise Development LP</p>
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../using-topologies/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../snapshot/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../js/navcleanup.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(false);
        };
    </script>

</body>
</html>
